version: 0.1
component: build
timeoutInSeconds: 3600
shell: bash

env:
  variables:
    REGISTRY: mx-queretaro-1.ocir.io
    NAMESPACE: axcez6ydclsd
    REPO: reacttodo/hviyu/todolistapp-springboot
  exportedVariables:
    - BUILDRUN_HASH

steps:
  - type: Command
    name: "Diagnostico estructura del repo"
    command: |
      echo "üìÅ Explorando estructura del repo completo:"
      find . -type f -name "pom.xml"
      echo "Contenido completo del repositorio (limitado a 3 niveles):"
      command -v tree && tree -L 3 || find . | head -n 100

  - type: Command
    name: Login to OCIR
    command: |
      echo "üîë Autenticando en OCIR..."
      echo "${auth_token_ocir}" \
        | docker login $REGISTRY \
            -u "${user_ocir}" \
            --password-stdin

  - type: Command
    name: Define unique image tag
    timeoutInSeconds: 40
    command: |
      export BUILDRUN_HASH=$(echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7)
      echo "BUILDRUN_HASH: $BUILDRUN_HASH"
      echo "BUILDRUN_HASH=$BUILDRUN_HASH" >> $OCI_DATA_OUT_DIR/build_env_vars

  - type: Command
    name: Build JAR with Maven + Repackage
    command: |
      echo "üì¶ Construyendo JAR con Maven..."
      cd backend
      mvn clean package spring-boot:repackage

  - type: Command
    name: Verificar JAR generado
    command: |
      echo "üîç Verificando JAR generado..."
      ls -lh backend/target/*.jar || echo "‚ùå No se gener√≥ ning√∫n JAR en backend/target"

  - type: Command
    name: Build & Push Docker Image
    command: |
      echo "üöÄ Construyendo imagen Docker y subi√©ndola..."
      cd backend

      echo "Intentando hacer pull de imagen previa (si existe)..."
      docker pull ${REGISTRY}/${NAMESPACE}/${REPO}:${BUILDRUN_HASH} || true

      echo "üîß Ejecutando Docker Build..."
      docker build --pull --no-cache \
        -f Dockerfile \
        -t ${REGISTRY}/${NAMESPACE}/${REPO}:${BUILDRUN_HASH} .

      echo "üì§ Subiendo imagen a OCIR..."
      docker push ${REGISTRY}/${NAMESPACE}/${REPO}:${BUILDRUN_HASH}

outputArtifacts:
  - name: todolist-image
    type: DOCKER_IMAGE
    location: ${REGISTRY}/${NAMESPACE}/${REPO}:${BUILDRUN_HASH}
