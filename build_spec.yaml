version: 0.1
component: build
timeoutInSeconds: 3600
shell: bash

env:
  variables:
    REGISTRY: mx-queretaro-1.ocir.io
    NAMESPACE: axcez6ydclsd
    REPO: reacttodo/hviyu/todolistapp-springboot
    DOCKERHUB_USER: axcez6ydclsd/a01637983@tec.mx
    DOCKERHUB_TOKEN: w62F8TpFa_)EvbuoS-J#
  exportedVariables:
    - BUILDRUN_HASH

steps:
  - type: Command
    name: üîë Definir hash √∫nico
    command: |
      echo "OCI_BUILD_RUN_ID: ${OCI_BUILD_RUN_ID}"
      export BUILDRUN_HASH=$(echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7)
      echo "BUILDRUN_HASH=$BUILDRUN_HASH" >> $OCI_OUTPUT_DIR/build_vars

  - type: Command
    name: üîê Login a OCIR
    command: |
      echo "${auth_token_ocir}" | docker login $REGISTRY -u "${user_ocir}" --password-stdin

  - type: Command
    name: üîê Login a Docker Hub
    command: |
      echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USER}" --password-stdin

  - type: Command
    name: üõ†Ô∏è Build y Push de imagen Spring Boot
    command: |
      cd MtdrSpring/backend
      docker build -t $REGISTRY/$NAMESPACE/$REPO:${BUILDRUN_HASH} .
      docker push $REGISTRY/$NAMESPACE/$REPO:${BUILDRUN_HASH}

outputArtifacts:
  - name: todolist-image
    type: DOCKER_IMAGE
    location: ${REGISTRY}/${NAMESPACE}/${REPO}:${BUILDRUN_HASH}
