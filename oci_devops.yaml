version: 0.1
component: build
timeoutInSeconds: 1800
shell: bash

env:
  variables:
    JAVA_HOME: /usr/lib64/graalvm/graalvm22-ee-java17

  exportedVariables:
    - BuildServiceDemoVersion

steps:
  - type: Command
    name: "Instalar GraalVM Native Image y kubectl"
    command: |
      yum -y install graalvm22-ee-17-native-image
      yum -y install kubectl

  - type: Command
    name: "Login a OCIR"
    command: |
      cd MtdrSpring
      oci os object get --bucket-name reacttodo-rolax --name deployment_config.tgz --file deployment_config.tgz
      tar -xzvf deployment_config.tgz
      source env.sh
      cat at.cfg | docker login mx-queretaro-1.ocir.io -u "$OCIR_USER" --password-stdin

  - type: Command
    name: "Build del proyecto Spring Boot"
    command: |
      cd MtdrSpring
      source env.sh
      export PATH=$JAVA_HOME/bin:$PATH
      cd backend
      chmod +x build.sh
      ./build.sh

  - type: Command
    name: "Build y Push de imagen Docker"
    command: |
      cd MtdrSpring
      source env.sh
      docker build -t $IMAGE_TAG -f Dockerfile backend
      docker push $IMAGE_TAG

  - type: Command
    name: "Deploy a Kubernetes"
    command: |
      cd MtdrSpring
      source env.sh
      chmod +x deploy.sh
      ./deploy.sh
